#!/bin/sh

PATH="/usr/bin:/bin:$PATH"
x=$(basename "$0")

if [ $# -eq 0 ]; then
  echo "USAGE : dec <file>"
  exit 1
fi

set -C
tmp=dec$$
trap 'rm -f "$tmp"; exit 1' HUP INT QUIT TERM

# cari tail (SAMA seperti encrypt)
tailcmd=""
IFS=":"; for d in $PATH; do
  [ -x "$d/tail" ] && tailcmd="$d/tail" && break
done
IFS=" "

[ -z "$tailcmd" ] && echo "tail tidak ditemukan" && exit 1

case `echo foo | $tailcmd -n +1 2>/dev/null` in
foo) tailcmd="$tailcmd -n";;
esac

res=0

for i do
  if [ ! -f "$i" ]; then
    echo "$x: $i bukan file"
    res=1
    continue
  fi

  # === DETEKSI SKIP (WAJIB DINAMIS) ===
  SKIP=$(sed -n '2p' "$i" | sed -n 's/^skip=\([0-9]\+\)$/\1/p')

  if [ -z "$SKIP" ]; then
    echo "$x: $i bukan file encrypt valid"
    res=1
    continue
  fi

  echo "[+] Decrypt $i (skip=$SKIP)"

  if ! $tailcmd +"$SKIP" "$i" | /bin/bzip2 -cd > "$tmp"; then
    echo "[!] Gagal decompress $i"
    res=1
    continue
  fi

  chmod 700 "$tmp"

  rm -f "$i~"
  mv "$i" "$i~" || {
    echo "[!] Gagal backup $i"
    rm -f "$tmp"
    res=1
    continue
  }

  mv "$tmp" "$i" || cp "$tmp" "$i" || {
    echo "[!] Gagal restore $i"
    rm -f "$tmp"
    res=1
    continue
  }

  echo "[âœ“] Decrypt sukses: $i"
done

exit $res
