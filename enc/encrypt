#!/bin/sh
# ============================================================
# FULL DECRYPTER - FIXED VERSION
# Compatible with SANZ (2023) encrypt script
# ============================================================

if [ $# -ne 1 ]; then
  echo "USAGE: $0 <encrypted_file>"
  exit 1
fi

FILE="$1"

if [ ! -f "$FILE" ]; then
  echo "[ERROR] File tidak ditemukan"
  exit 1
fi

# Cari nilai skip
SKIP=$(grep -m1 '^skip=[0-9]\+' "$FILE" | cut -d= -f2)

if [ -z "$SKIP" ]; then
  echo "[ERROR] Tidak ditemukan nilai skip"
  echo "File ini kemungkinan BUKAN hasil encrypt"
  exit 1
fi

OUT="${FILE}.decrypted"

echo "[INFO] Skip baris : $SKIP"
echo "[INFO] Decrypting..."

# Decrypt payload
if tail -n +"$SKIP" "$FILE" | bzip2 -cd > "$OUT" 2>/dev/null; then
  chmod +x "$OUT"
  echo "[SUCCESS] Decrypt berhasil"
  echo "[OUTPUT ] $OUT"
else
  echo "[FAILED] Payload bukan bzip2 valid"
  exit 1
fi

exit 0
