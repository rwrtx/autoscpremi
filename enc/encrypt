#!/bin/sh
# ============================================================
# FULL DECRYPTER FOR BZIP2 SELF-EXTRACTING SHELL
# Compatible with SANZ (2023) encrypt script
# ============================================================

if [ $# -lt 1 ]; then
  echo "USAGE : ./decrypt.sh <file_encrypted>"
  exit 1
fi

FILE="$1"

if [ ! -f "$FILE" ]; then
  echo "[ERROR] File tidak ditemukan"
  exit 1
fi

# Ambil nilai skip dari baris ke-2
SKIP_LINE=$(sed -n '2p' "$FILE")

case "$SKIP_LINE" in
  skip=*)
    eval "$SKIP_LINE"
    ;;
  *)
    echo "[ERROR] File ini bukan hasil encrypt yang valid"
    exit 1
    ;;
esac

OUTFILE="${FILE}.decrypted"

echo "[INFO] Skip baris: $skip"
echo "[INFO] Decrypting..."

# Proses decrypt
if tail -n +"$skip" "$FILE" | bzip2 -cd > "$OUTFILE"; then
  chmod +x "$OUTFILE"
  echo "[SUCCESS] Decrypt selesai"
  echo "[OUTPUT ] $OUTFILE"
else
  echo "[FAILED] Gagal decrypt file"
  exit 1
fi

exit 0
