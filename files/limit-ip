#!/bin/bash

function send_log() {
    KEY="7253550837:AAEZbitnFTqwNmBqCuvybJfaxHKgYb7FrZ4"
    CHATID="6579436198"
  #CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
  #KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
  TIME="10"
  URL="https://api.telegram.org/bot$KEY/sendMessage"
  TEXT="
  <code>────────────────────</code>
  <b>⚠️ NOTIFICATIONS MULTI LOGIN ⚠️</b>
  <code>────────────────────</code>
  <code>Username  : </code><code>$user</code>
  <code>Limit Ip  : </code><code>$iplimit</code>
  <code>────────────────────</code>
  "
  curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null
}

function vmip(){
  # LIMITVMESSIP
  echo -n > /var/log/xray/access.log
  sleep 1
  data=( `ls /etc/kyt/limit/vmess/ip`)
  # Decrypted By YADDY D PHREAKER
  for user in "${data[@]}"
  do
    iplimit=$(cat /etc/kyt/limit/vmess/ip/$user)
    ehh=$(cat /var/log/xray/access.log | grep "$user" | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq)
    cekcek=$(echo -e "$ehh" | wc -l)
    if [[ $cekcek -gt $iplimit ]]; then
      exp=$(grep -w "^### $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
      
      # Simpan konfigurasi sebelum dihapus
      sed -n "/^### $user $exp/,/^},{/p" /etc/xray/config.json > /tmp/$user.xray.backup
      sed -n "/^### $user $exp/p" /etc/vmess/.vmess.db > /tmp/$user.vmess.backup
      
      # Hapus konfigurasi pengguna dari file konfigurasi Xray dan database Vmess
      sed -i "/^### $user $exp/,/^},{/d" /etc/xray/config.json
      sed -i "/^### $user $exp/d" /etc/vmess/.vmess.db
      
      # Restart layanan Xray
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file batas IP pengguna
      rm -rf /etc/kyt/limit/vmess/ip/$user
      
      # Kirim log notifikasi ke bot Telegram
      send_log
      
      # Tunggu 15 menit sebelum mengembalikan konfigurasi
      sleep 900
      
      # Kembalikan konfigurasi yang disimpan sebelumnya
      cat /tmp/$user.xray.backup >> /etc/xray/config.json
      cat /tmp/$user.vmess.backup >> /etc/vmess/.vmess.db
      
      # Restart layanan Xray lagi untuk menerapkan perubahan
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file backup setelah selesai
      rm -f /tmp/$user.xray.backup /tmp/$user.vmess.backup
    else
      echo ""
    fi
    sleep 0.1
  done
}

function vlip(){
  # LIMITVLESSIP
  echo -n > /var/log/xray/access.log
  sleep 1
  data=( `ls /etc/kyt/limit/vless/ip`)
  # Decrypted By YADDY D PHREAKER
  for user in "${data[@]}"
  do
    iplimit=$(cat /etc/kyt/limit/vless/ip/$user)
    ehh=$(cat /var/log/xray/access.log | grep "$user" | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq)
    cekcek=$(echo -e "$ehh" | wc -l)
    if [[ $cekcek -gt $iplimit ]]; then
      exp=$(grep -w "^#& $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
      
      # Simpan konfigurasi sebelum dihapus
      sed -n "/^#& $user $exp/,/^},{/p" /etc/xray/config.json > /tmp/$user.xray.backup
      sed -n "/^### $user $exp/p" /etc/vless/.vless.db > /tmp/$user.vless.backup
      
      # Hapus konfigurasi pengguna dari file konfigurasi Xray dan database Vless
      sed -i "/^#& $user $exp/,/^},{/d" /etc/xray/config.json
      sed -i "/^### $user $exp/d" /etc/vless/.vless.db
      
      # Restart layanan Xray
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file batas IP pengguna
      rm -rf /etc/kyt/limit/vless/ip/$user
      
      # Kirim log notifikasi ke bot Telegram
      send_log
      
      # Tunggu 15 menit sebelum mengembalikan konfigurasi
      sleep 900
      
      # Kembalikan konfigurasi yang disimpan sebelumnya
      cat /tmp/$user.xray.backup >> /etc/xray/config.json
      cat /tmp/$user.vless.backup >> /etc/vless/.vless.db
      
      # Restart layanan Xray lagi untuk menerapkan perubahan
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file backup setelah selesai
      rm -f /tmp/$user.xray.backup /tmp/$user.vless.backup
    else
      echo ""
    fi
    sleep 0.1
  done
}

function trip(){
  # LIMITIPTROJAN
  echo -n > /var/log/xray/access.log
  sleep 1
  data=( `ls /etc/kyt/limit/trojan/ip`)
  # Decrypted By YADDY D PHREAKER
  for user in "${data[@]}"
  do
    iplimit=$(cat /etc/kyt/limit/trojan/ip/$user)
    ehh=$(cat /var/log/xray/access.log | grep "$user" | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq)
    cekcek=$(echo -e "$ehh" | wc -l)
    if [[ $cekcek -gt $iplimit ]]; then
      exp=$(grep -w "^#! $user" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)
      
      # Simpan konfigurasi sebelum dihapus
      sed -n "/^#! $user $exp/,/^},{/p" /etc/xray/config.json > /tmp/$user.xray.backup
      sed -n "/^### $user $exp/p" /etc/trojan/.trojan.db > /tmp/$user.trojan.backup
      
      # Hapus konfigurasi pengguna dari file konfigurasi Xray dan database Trojan
      sed -i "/^#! $user $exp/,/^},{/d" /etc/xray/config.json
      sed -i "/^### $user $exp/d" /etc/trojan/.trojan.db
      
      # Restart layanan Xray
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file batas IP pengguna
      rm -rf /etc/kyt/limit/trojan/ip/$user
      
      # Kirim log notifikasi ke bot Telegram
      send_log
      
      # Tunggu 15 menit sebelum mengembalikan konfigurasi
      sleep 900
      
      # Kembalikan konfigurasi yang disimpan sebelumnya
      cat /tmp/$user.xray.backup >> /etc/xray/config.json
      cat /tmp/$user.trojan.backup >> /etc/trojan/.trojan.db
      
      # Restart layanan Xray lagi untuk menerapkan perubahan
      systemctl restart xray >> /dev/null 2>&1
      
      # Hapus file backup setelah selesai
      rm -f /tmp/$user.xray.backup /tmp/$user.trojan.backup
    else
      echo ""
    fi
    sleep 0.1
  done
}

if [[ ${1} == "vmip" ]]; then
  vmip
elif [[ ${1} == "vlip" ]]; then
  vlip
elif [[ ${1} == "trip" ]]; then
  trip
fi
