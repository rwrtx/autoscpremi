#!/bin/bash

LOCK_TIME=900  # Waktu penguncian dalam detik (15 menit)
LOCK_FILE="/tmp/locked_ips.txt"  # File untuk menyimpan IP yang dikunci

# Pengaturan untuk bot kedua
BOT2_TOKEN="7253550837:AAEZbitnFTqwNmBqCuvybJfaxHKgYb7FrZ4"
BOT2_CHAT_ID="6579436198"

# Fungsi untuk mengirim log ke bot Telegram
function send_log(){
    # Pengaturan untuk bot pertama dari file konfigurasi
    CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
    KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
    TIME="10"
    URL="https://api.telegram.org/bot$KEY/sendMessage"
    
    TEXT="
<code>────────────────────</code>
<b>⚠️ NOTIFICATIONS MULTI LOGIN XRAY ⚠️</b>
<code>────────────────────</code>
<code>Isp              : </code><code>${isp}</code>
<code>Domain           : </code><code>${domain}</code>
<code>────────────────────</code>
<code>Username         : </code><code>$user</code>
<code>Limit IP         : </code><code>${iplimit}</code>
<code>Login IP Count   : </code><code>${cekcek}</code>
<code>────────────────────</code>
<code>User IP          : </code>
<code>${user_ips}</code>
<code>────────────────────</code>
<code>Multi-Login IP   : </code>
<code>${multi_login_ips}</code>
<code>────────────────────</code>
"

    # Mengirim pesan ke bot pertama
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL >/dev/null

    # URL untuk bot kedua
    URL_BOT2="https://api.telegram.org/bot$BOT2_TOKEN/sendMessage"

    # Mengirim pesan ke bot kedua
    curl -s --max-time $TIME -d "chat_id=$BOT2_CHAT_ID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" $URL_BOT2 >/dev/null
}

# Fungsi untuk memeriksa apakah IP sudah dikunci
function is_ip_blocked() {
    local ip=$1
    iptables -L INPUT -v -n | grep "$ip" > /dev/null 2>&1
}

# Fungsi untuk mengunci IP menggunakan iptables
function block_ip() {
    local ip=$1
    if ! is_ip_blocked $ip; then
        iptables -A INPUT -s $ip -j DROP
        echo "Blocking IP: $ip"
    else
        echo "IP: $ip is already blocked"
    fi
}

# Fungsi untuk membuka kunci IP yang sudah melewati waktu penguncian
function unblock_ip() {
    local ip=$1
    iptables -D INPUT -s $ip -j DROP
    echo "Unblocking IP: $ip"
}

# Fungsi untuk memproses pembukaan kunci IP berdasarkan waktu penguncian
function unlock_ips() {
    local current_time=$(date +%s)
    local tmp_file=$(mktemp)

    while read -r line; do
        local timestamp=$(echo $line | awk '{print $1}')
        local ip=$(echo $line | awk '{print $2}')
        local user=$(echo $line | awk '{print $3}')

        if (( current_time - timestamp > LOCK_TIME )); then
            unblock_ip $ip
        else
            echo $line >> $tmp_file
        fi
    done < $LOCK_FILE

    mv $tmp_file $LOCK_FILE
}

# Fungsi umum untuk memproses IP pada layanan tertentu
function process_ips() {
    local service_type=$1
    echo -n > /var/log/xray/access.log
    sleep 60  # Mengubah waktu tunggu menjadi 1 menit
    data=( `ls /etc/kyt/limit/${service_type}/ip`)
    unlock_ips  # Membuka kunci IP yang sudah melewati waktu penguncian

    isp=$(cat /etc/xray/isp)
    domain=$(cat /etc/xray/domain)
    
    for user in "${data[@]}"; do
        iplimit=$(cat /etc/kyt/limit/${service_type}/ip/$user)
        ehh=$(grep "$user" /var/log/xray/access.log | cut -d " " -f 3 | sed 's/tcp://g' | cut -d ":" -f 1 | sort | uniq)
        cekcek=$(echo -e "$ehh" | wc -l)
        user_ips=$(echo $ehh | tr '\n' ' ')  # Mengumpulkan IP user
        
        multi_login_ips=""
        
        if [[ $cekcek -gt $iplimit ]]; then
            multi_login_ips=$user_ips  # Menyimpan IP yang melebihi batas login
            for ip in $ehh; do
                block_ip $ip  # Mengunci IP
                echo "$(date +%s) $ip $user" >> $LOCK_FILE  # Menyimpan IP yang dikunci
            done
            send_log  # Mengirim log dengan detail IP hanya sekali setelah semua IP diproses
        fi
        sleep 0.1
    done
}

if [[ ${1} == "vmip" ]]; then
    process_ips "vmess"
elif [[ ${1} == "vlip" ]]; then
    process_ips "vless"
elif [[ ${1} == "trip" ]]; then
    process_ips "trojan"
fi
