#!/bin/bash

# Direktori konfigurasi dan backup
CONFIG_DIR="/etc/xray"
VMESS_DB_FILE="/etc/vmess/.vmess.db"
TROJAN_DB_FILE="/etc/trojan/.trojan.db"
VLESS_DB_FILE="/etc/vless/.vless.db"
BACKUP_DIR="/etc/kyt/backup"

# Detail Telegram
CHATID="5423129090"
KEY="6782755839:AAEtaEt8JKHdzXvIDdzNAn1kYuTQxOdgyH4"
URL="https://api.telegram.org/bot$KEY/sendMessage"
TIME="10"

# Fungsi backup data
backup_data() {
    echo "Membackup data konfigurasi..."
    mkdir -p "$BACKUP_DIR"
    cp "$CONFIG_DIR/config.json" "$BACKUP_DIR/config.json.bak"
    cp "$VMESS_DB_FILE" "$BACKUP_DIR/vmess.db.bak"
    cp "$TROJAN_DB_FILE" "$BACKUP_DIR/trojan.db.bak"
    cp "$VLESS_DB_FILE" "$BACKUP_DIR/vless.db.bak"
    echo "Backup selesai."
}

# Fungsi restore data
restore_data() {
    echo "Mengembalikan data konfigurasi..."
    cp "$BACKUP_DIR/config.json.bak" "$CONFIG_DIR/config.json"
    cp "$BACKUP_DIR/vmess.db.bak" "$VMESS_DB_FILE"
    cp "$BACKUP_DIR/trojan.db.bak" "$TROJAN_DB_FILE"
    cp "$BACKUP_DIR/vless.db.bak" "$VLESS_DB_FILE"
    echo "Restore selesai."
}

# Fungsi menghapus IP login
remove_ip_log() {
    local user=$1
    echo "Menghapus IP login untuk user $user..."
    rm -f "/etc/kyt/limit/vmess/ip/$user"
}

# Fungsi mengunci akun
lock_account() {
    local user=$1
    echo "Mengunci akun $user selama 1 menit untuk uji coba..."
    backup_data
    remove_ip_log "$user"
    sleep 1m
    restore_data
    echo "Akun $user telah dibuka kembali."
}

# Fungsi mengirim notifikasi ke Telegram
send_telegram_notification() {
    local user=$1
    local ip_count=$2
    local message="<code>User: $user</code>
<code>Batas IP: $limit</code>
<code>Jumlah IP: $ip_count</code>
<code>Status: Dikunci selama 1 menit</code>"
    
    curl -s --max-time $TIME -d "chat_id=$CHATID&disable_web_page_preview=1&text=$message&parse_mode=html" $URL >/dev/null
}

# Fungsi utama untuk memantau dan mengunci akun jika melebihi batas IP
monitor_and_lock() {
    local limit=3
    local user_list=$(grep -oP '(?<=### ).*?(?= )' $VMESS_DB_FILE)

    for user in $user_list; do
        local ip_count=$(grep -w $user /var/log/xray/access.log | awk '{print $3}' | sort | uniq | wc -l)
        if [[ $ip_count -gt $limit ]]; then
            lock_account $user
            send_telegram_notification $user $ip_count
        fi
    done

    local trojan_user_list=$(grep -oP '(?<=### ).*?(?= )' $TROJAN_DB_FILE)

    for user in $trojan_user_list; do
        local ip_count=$(grep -w $user /var/log/xray/access.log | awk '{print $3}' | sort | uniq | wc -l)
        if [[ $ip_count -gt $limit ]]; then
            lock_account $user
            send_telegram_notification $user $ip_count
        fi
    done

    local vless_user_list=$(grep -oP '(?<=### ).*?(?= )' $VLESS_DB_FILE)

    for user in $vless_user_list; do
        local ip_count=$(grep -w $user /var/log/xray/access.log | awk '{print $3}' | sort | uniq | wc -l)
        if [[ $ip_count -gt $limit ]]; then
            lock_account $user
            send_telegram_notification $user $ip_count
        fi
    done
}

# Contoh penggunaan
monitor_and_lock
